---
title: "Cleveland Indians Game Duration"
subtitle: "Data Exploration"
author: "Michael Foley"
date: "`r Sys.Date()`"
output: 
  html_document:
    css: "style.css"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(lubridate)
library(ggthemes)
library(extrafont)
library(fpp3)
library(tsibble)
library(fable)
library(patchwork) # for arranging plots
library(glue)
library(png)
library(gridGraphics)
library(grid)

cle_colors <- c("navy_blue" = "#0C2340", "red" = "#E31937")
oak_colors <- c("gold" = "#efb21e", "kellygreen" = "#003831")
vintage_colors <- c("#CBBCB1", "#AF6B58", "#556052", "#F2EFEA")
all_colors <- c(cle_colors, oak_colors, vintage_colors)
names(all_colors) <- NULL

# Instead of typing this out for every ggplot
theme_mlb <- theme(
  text = element_text(size = 16, family = "Rockwell Condensed", color = cle_colors["navy_blue"]),
  panel.grid.minor = element_blank())

ball_png <- png::readPNG("baseball.png", native = TRUE)
ball_grob <- grid::rasterGrob(ball_png, interpolate = FALSE)

# Pretty h:m
pretty_hm <- function(hrs) { 
  str_sub(chron::times(hrs %/% 60 + hrs %% 60 / 60) / 24, 5, 8) 
}
```

```{r data}
# Get data from prior step
cle_games <- readRDS("./cle_games.rds")
```

The Baseball-Reference web site for the [2021 Cleveland Indians](https://www.baseball-reference.com/teams/CLE/2021.shtml) provides game-by-game results since the first season in 1901. This project is an investigation into the increase in game duration. Games today last nearly twice as long as they did in 1901. Baseball-Reference has a rich source of game features that might help explain trends in game time. In [step 1](https://github.com/mpfoley73/cleveland-mlb-games/blob/main/step_1_get_games.R) of this project I aggregated `r n_distinct(cle_games$season)` seasons of data sets into a single data frame, `cle_games`. Let's start with a brief look at the structure of the data. `r n_distinct(cle_games$season)` seasons comprising `r scales::comma(nrow(cle_games))` games. The `game_date` and `game_duration` columns will be important. A few others seem interesting too: `day_ind` (day or night game), which game of a `doubleheader_game` if applicable, `runs_scored` and `runs_allowed`, `innings`, and `attendance`.

```{r}
skimr::skim(cle_games)
```

The seven character fields are interesting to read for nostalgia's sake (e.g., Lenny Barker's [1981](https://www.baseball-reference.com/teams/CLE/1981-schedule-scores.shtml) no-hitter on May 15 was against the Blue Jays and the win brought our record to 16-8), but these features won't play a role in this analysis.

The lone date field is `game_date`. That's going to be critical for trend analysis.

The factor fields are interesting. `day_ind` is either "Day" or "Night". Compared to lazy afternoons, evening games feel electric and I wonder if that translates into shorter games at night. `doubleheader_game` indicates which game of a doubleheader, if applicable. When I played, I felt like two hours of baking in the sun was plenty, but did I do anything to hasten along a doubleheader? 

```{r}
# Survey Object

Set up a survey object using the **survey** package.

```{r fig.height=3.0, fig.width=3.5, warning=FALSE}
pew_survey <- svydesign(
  ids = ~1,
  weights = ~ weight,
  data = pew_dat_1
)

svytable(~simple_eth + CENIDENTITYb, pew_survey) %>%
  as_tibble() %>% 
  pivot_wider(names_from = CENIDENTITYb, values_from = n) %>%
  adorn_percentages()
```

```{r}
# x <- svyglm(CENIDENTITYb~simple_eth, family=quasibinomial, design = pew_survey, na.action = na.omit) 
# x %>% broom::tidy(exponentiate = TRUE)
# 
# x <- svyby(~CENIDENTITYb, ~simple_eth, pew_survey, svymean, covmat = TRUE)
# vcov(x)
# svycontrast(x, c(-1, 1))
```
```

## Benchmark Forecasts

This following sections will use time series analysis to forecast attendance. Some forecasting methods are extremely simple and surprisingly effective. Here are four. I'll keep them in mind as benchmarks to evaluate the more sophisticated methods. I denote a forecast value with the "hat" notation, $\hat{y}_{T+h|T}$. The subscript $T + h$ means forecasting $h$ periods beyond the observed time series $T$. $\hat{y}_{T+h|T}$ means an $h$ period forecast beyond $T$ based on data through period $T$.

* The **average method** projects the historical average, $\hat{y}_{T+h|T} = \bar{y}.$ 
* The **naive method** projects the last observation, $\hat{y}_{T+h|T} = y_T.$ 
* The **seasonal naive method** projects the last seasonal observation, $\hat{y}_{T+h|T} = y_{T+h-m(k+1)}$. 

The methods can include drift, a straight line from the first and last observation, $\hat{y}_{T+h|T} = y_T + h\left(\frac{y_T - y_1}{T-1}\right).$

```{r warning=FALSE}
cle_tsibble_yr %>%
  # fill_gaps() %>%
  model(Average = MEAN(game_hrs9),
        Naive = NAIVE(game_hrs9),
        RW = RW(game_hrs9 ~ drift())) %>%
  forecast(h = 10) %>%
  ggplot(aes(x = yr)) +
  geom_line(aes(y = .mean, color = .model)) +
  geom_line(data = cle_tsibble_yr %>% filter(yr >= 1911) %>% fill_gaps(), aes(y = game_hrs9)) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(breaks = seq(1900, 2030, 10)) +
  theme_light() +
  labs(title = "Three benchmark Tribe game duration forecasts.",
       subtitle = "Average, naive, and random walk forecasts, h = 10 seasons.", 
       x = NULL, y = "Hours", color = NULL,
       caption = "source: www.baseball-reference.com.") +
  theme_mlb +
  guides(color = guide_legend(title = "Forecast"))
```

```{r}
saveRDS(cle_tsibble_yr, "./cle_tsibble_yr.rds")
save(
  step_2_fig1, step_2_fig2, step_2_fig3, step_2_fig4, scale_factor,
  file = "step_2.RData"
)
```
